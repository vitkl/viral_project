---
title: "Motif search for known motifs in viral proteins"
author: "Vitalii Kleshchevnikov"
date: "29/11/2017"
output: 
  html_document: 
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages = c("MItools", "rtracklayer", "R.utils", "ontologyIndex", "parallel")
if(mean(packages %in% names(installed.packages()[,"Package"])) != 1){
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    # specifying mirror is necessary for some Linux systems
    install.packages(packages_to_install, dependencies = T, repos = "http://mirrors.ebi.ac.uk/CRAN/")
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    source("https://bioconductor.org/biocLite.R")
    biocLite(packages_to_install)
    devtools::install_github("vitkl/MItools", dependencies = T)
}

suppressPackageStartupMessages({
    library(MItools)
    library(rtracklayer)
    library(parallel)
})
```

# Introduction

## Strategies

1. Optimal search settings (default):  
- slimlen= 5: Maximum length of SLiMs to return (no. non-wildcard positions)  
- maxwild= 2: Maximum number of consecutive wildcard positions to allow  

2. Comparing interaction datasets (2):  
- Full IntAct  
- Vidal  
- all_viral_interaction  
- BioPlex  
- Randomised BioPlex  

3. Protein-centered strategy (1)  

4. QSLIMFinder (1)  

Total: 1 \* 1 \* 2 \* 1 \* 1 = 5 conditions  

## load PPI data

```{r load_data}
# load ppi data
IntAct = loadIntActFTP(dir = "./data_files/IntActRelease_2017Nov13/",
                                                release = "2017Nov13")
# human-viral
all_viral_interaction4 = interSpeciesInteractome(taxid1 = 9606, taxid2 = 10239, database = "IntActFTP", format = "tab27",
                                                clean = TRUE, protein_only = TRUE,
                                                MITABdata = IntAct, directory = "./data_files/",
                                                releaseORdate = "2017Nov13")
# need to simplify isoform IDs for human proteins
all_viral_interaction_BioPlex4 = copy(all_viral_interaction4)
all_viral_interaction_BioPlex4$data$IDs_interactor_A = gsub("-[[:digit:]]+$","",
                                                            all_viral_interaction_BioPlex4$data$IDs_interactor_A)
all_viral_interaction_BioPlex4$data$pair_id = paste0(all_viral_interaction_BioPlex4$data$IDs_interactor_A,
                                                     "|", all_viral_interaction_BioPlex4$data$IDs_interactor_B)
all_viral_interaction_BioPlex4$data = unique(all_viral_interaction_BioPlex4$data)

# human-human
Full_IntAct4 = fullInteractome(taxid = 9606, database = "IntActFTP", format = "tab27",
                              clean = TRUE, protein_only = TRUE,
                              MITABdata = IntAct, directory = "./data_files/",
                                                releaseORdate = "2017Nov13")

Vidal4 = subsetMITABbyPMIDs(MITABdata = Full_IntAct4,
                           PMIDs = c("25416956", "unassigned1304"))

BioPlex4 = loadBioplex(dir = "./data_files/",
                      url = "http://bioplex.hms.harvard.edu/data/BioPlex_2.3_interactionList.tsv")

randomised_BioPlex4 = copy(BioPlex4)
randomised_BioPlex4$data$Publication_Identifiers = NA
randomised_BioPlex4$data$Confidence_values = NA
randomised_BioPlex4$data = unique(randomised_BioPlex4$data)
set.seed(1)
randomised_BioPlex4$data$IDs_interactor_B = randomised_BioPlex4$data$IDs_interactor_B[sample.int(length(randomised_BioPlex4$data$IDs_interactor_B))]
randomised_BioPlex4$data$pair_id = paste0(randomised_BioPlex4$data$IDs_interactor_A, "|", randomised_BioPlex4$data$IDs_interactor_B)
```

```{r protein_w_known_motifs}
# find human proteins that bind viral proteins with known motifs
# load viral proteins with known motifs from ELM
dbfile = "./data_files/instances10239.gff"
dburl = "http://elm.eu.org/instances.gff?q=all&taxon=irus&instance_logic="
viral_instances = ELMdb2GRanges(dbfile = dbfile,
                                  dburl = dburl,
                                  tsvurl = gsub("gff", "tsv", dburl),
                                  tsvfile = gsub("gff", "tsv", dbfile))
viral_proteins_w_known_motifs = unique(as.character(seqnames(viral_instances)))
# get network for these proteins
viral_net_w_known_motifs = subsetMITABbyID(all_viral_interaction4,
                                           ID_seed = viral_proteins_w_known_motifs)
# extract human proteins from this network to use as seed for QSLIMFinder datasets
human_proteins = extractInteractors(viral_net_w_known_motifs, taxid = 9606)
```

## Set standard options

```{r std_options}
# set standard options
myPPInetwork2SLIMFinder = function(dataset_name = "SLIMFinder", slimlen = 5, maxwild = 2,
                                   interaction_main_set, interaction_query_set,
                                   center_domains = F, analysis_type = "qslimfinder",
                                   conmask = F){
    PPInetwork2SLIMFinder(dataset_name = dataset_name,
                          interaction_main_set = interaction_main_set,
                          interaction_query_set = interaction_query_set,
                          analysis_type = analysis_type,
                          options = paste0("dismask=T consmask=",conmask," cloudfix=T probcut=1 minwild=0 maxwild=",maxwild," slimlen=",slimlen," alphahelix=F maxseq=800 savespace=0 iuchdir=T extras=2"),
                          domain_res_file = "./processed_data_files/what_we_find_VS_ELM_clust20171019.RData",
                          domain_results_obj = "res_count",
                          center_domains = center_domains,
                          fasta_path = "./data_files/all_human_viral_proteins.fasta",
                          main_set_only = F,
                          domain_pvalue_cutoff = 1,
                          SLIMFinder_dir = paste0("./",dataset_name,"/"),
                          LSF_project_path = "/hps/nobackup/research/petsalaki/users/vitalii/vitalii/viral_project/",
                          software_path = "../software/cluster/",
                          length_set1_min = 2,
                          length_set2_min = 1,
                          write_log = T,
                          N_seq = 200,
                          seed_list = human_proteins, # human proteins that bind viral proteins with known motifs 
                          memory_start = 350,
                          memory_step = 2000,
                          Njobs_limit = 200)
}

# Download ELM data
elm_filename = paste0("/hps/nobackup/research/petsalaki/users/vitalii/vitalii/viral_project/", "./data_files/", Sys.Date(), 
                      "elms_index.tsv")
if (!file.exists(elm_filename)) 
    download.file("http://elm.eu.org/elms/elms_index.tsv", elm_filename)
```

## Define parameters

```{r params}
analysis_type = c("qslimfinder")
datasets = c("Full_IntAct4", "Vidal4", "all_viral_interaction4", "BioPlex4", "randomised_BioPlex4")
domain_centered = c(F) # c(F, T)
#slimlen = c(5, 8, 10)
#maxwild = c(2, 3)

dataset_names = data.table(analysis_type = character(), datasets = character(),
                           domain_centered = logical(), dataset_names = character(), 
                           slimlen = integer(), maxwild = integer())
for(a in analysis_type){
    for(d in datasets){
        for(cen in domain_centered){
            dataset_names_temp = data.table(analysis_type = a, datasets = d,
                                            domain_centered = cen, dataset_names = paste(a,d,cen, sep = "."), 
                                            slimlen = 5, maxwild = 2)
            dataset_names = rbind(dataset_names, dataset_names_temp)
        }
    }
}
dataset_names[grepl("BioPlex",datasets), query_dataset := "all_viral_interaction_BioPlex4"]
dataset_names[!grepl("BioPlex",datasets), query_dataset := "all_viral_interaction4"]

# remove already finished names
if(!file.exists("./RData_from_Motif_search_4_known_motifs")) file.create("./RData_from_Motif_search_4_known_motifs")
R_data_names = readLines("./RData_from_Motif_search_4_known_motifs")
R_data_names = gsub("\\./processed_data_files/QSLIMFinder_instances_h2v_","", R_data_names)
dataset_names = dataset_names[!dataset_names %in% R_data_names]
```

## Perform motif search

```{r search}
# set up parallel processing
# create cluster
cores = 3
cl <- makeCluster(cores)
# get library support needed to run the code
clusterEvalQ(cl, {library(MItools); library(rtracklayer)})
# put objects in place that might be needed for the code
clusterExport(cl, ls(), envir=environment())

R_data = parSapplyLB(cl = cl, X = 1:nrow(dataset_names), FUN = function(i){
    R_data_name = myPPInetwork2SLIMFinder(dataset_name = dataset_names$dataset_names[i], 
                            slimlen = dataset_names$slimlen[i], maxwild = dataset_names$maxwild[i],
                            interaction_main_set = eval(parse(text = dataset_names$datasets[i])),
                            interaction_query_set = eval(parse(text = dataset_names$query_dataset[i])),
                            center_domains = dataset_names$domain_centered[i], 
                            analysis_type = dataset_names$analysis_type[i])
    
    zip(zipfile = paste0(R_data_name, ".zip"), files = R_data_name)
    unlink(R_data_name)
    
    R_data_names = readLines("./RData_from_Motif_search_4_known_motifs")
    R_data_names = c(R_data_names, paste0(R_data_name, ".zip"))
    write(R_data_names, "./RData_from_Motif_search_4_known_motifs")
    
    paste0(R_data_name, ".zip")
}, simplify = TRUE, USE.NAMES = TRUE) # parSapplyLB is parSapply that accounts for different time each dataset might take

stopCluster(cl)

# paths to RData files containing all objects created by all runs of this pipeline
print(R_data)
```

```{r, exit}
Sys.Date. = Sys.Date()
Sys.Date.
session_info. = devtools::session_info()
session_info.
filename = paste0("./processed_data_files/motif_search_4_known_motifs",
                  format(Sys.Date(), "%Y%m"),"_",
                  paste0(analysis_type,collapse = "_"),
                  paste0(datasets,collapse = "_"),
                  paste0(domain_centered,collapse = "_"),
                  ".RData")
save(list = ls(), file=filename)
```