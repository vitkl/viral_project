{
    "collab_server" : "",
    "contents" : "---\ntitle: \"viral protein - human domain interaction\"\nauthor: \"Vitalii Kleshchevnikov\"\ndate: \"10/05/2017\"\noutput: \n  html_document: \n    fig_height: 6\n    fig_width: 8\n    keep_md: yes\n    toc: yes\n    toc_depth: 4\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = F, message = F, warning = F)\npackages = c(\"data.table\",\"downloader\",\"R.utils\",\"UniProt.ws\", \"igraph\",\"Matrix\",\"expm\", \"caTools\", \"IRanges\",\"PSICQUIC\",\"ggplot2\", \"clusterProfiler\", \"scales\", \"qvalue\", \"gplots\", \"RColorBrewer\", \"DT\")\nif(mean(packages %in% names(installed.packages()[,\"Package\"])) != 1){\n      packages_to_install = packages[!packages %in% names(installed.packages()[,\"Package\"])]\n      install.packages(packages_to_install)\n      packages_to_install = packages[!packages %in% names(installed.packages()[,\"Package\"])]\n      source(\"https://bioconductor.org/biocLite.R\")\n      biocLite(packages_to_install)\n}\n\nsuppressPackageStartupMessages({\n        library(data.table)\n        library(downloader)\n        library(R.utils)\n        library(UniProt.ws)\n        library(igraph)\n        library(Matrix)\n        library(expm)\n        library(caTools)\n        library(IRanges)\n        library(PSICQUIC)\n        library(ggplot2)\n        library(clusterProfiler)\n        library(scales)\n        library(qvalue)\n        library(gplots)\n        library(RColorBrewer)\n        library(DT)\n        })\n```\n\nI download all protein-protein interactions from IntAct (IMEx databases) involving viral proteins using PSICQUIC service in MITAB2.7 format.\n\n```{r PSICQUIC}\nif(!file.exists(\"./source_files/human_viral_interactions.txt\")){\n    ## Load PSICQUIC functionality\n    psicquic <- PSICQUIC()\n    providers <- providers(psicquic)\n    databases <- c(\"IntAct\", \"MINT\", \"bhf-ucl\", \"MPIDB\", \"MatrixDB\", \n                   \"HPIDb\",\"I2D-IMEx\",\"InnateDB-IMEx\", \"MolCon\", \"UniProt\", \"MBInfo\")\n    \n    PSICQUIC_query = paste(\"species:10239\")\n    SPECIES_ID_interactome = data.table()\n    NO_SPECIES_ID_interactome = character(length = length(databases))\n    for(indices in 1:length(databases)) {\n      if(databases[indices] %in% providers) {\n        ## Query for the number of interactions\n        PSICQUIC_query1 = paste0(PSICQUIC_query, \"?format=count\") \n        N_interactions <- unlist(rawQuery(psicquic, databases[indices], PSICQUIC_query1))\n        ## if there are any interactions - Query for the interactions by 1000 at a time\n        if(N_interactions > 0){\n          N_start = 1\n          N_nrows = 2500\n          for(n_starts in seq(from = N_start, to = N_interactions, by = N_nrows)){\n            PSICQUIC_query2 = paste0(PSICQUIC_query, \"?format=\",\"tab27\",\"&firstResult=\", n_starts,\n                                     \"&maxResults=\", N_nrows) \n            SPECIES_ID_interactome_d <- as.data.table(rawQuery(psicquic, databases[indices], PSICQUIC_query2))\n            SPECIES_ID_interactome <- rbind(SPECIES_ID_interactome, SPECIES_ID_interactome_d)\n          }\n        }\n        ## if the query finds no interactors\n        else {\n          NO_SPECIES_ID_interactome[indices] = databases[indices]\n        }\n      }\n      ## if the database is not active\n      else {\n        NO_SPECIES_ID_interactome[indices] = databases[indices]\n      }\n    }\nfwrite(SPECIES_ID_interactome,\"./source_files/human_viral_interactions.txt\", sep = \"\\t\")\nall_viral_interaction = SPECIES_ID_interactome\n}\n\nall_viral_interaction = fread(\"./source_files/human_viral_interactions.txt\", stringsAsFactors = F)\n```\n\nI filter and keep only human-viral interactions.\n\n```{r human_viral}\ncolnames(all_viral_interaction) = unlist(strsplit(readLines(\"ftp://ftp.ebi.ac.uk/pub/databases/intact/current/psimitab/intact.txt\",  n = 1), \"\\t\"))\n\n# changing column names to data.table-compatible format\n{\ncolnames(all_viral_interaction) = gsub(\" \",\"_\",colnames(all_viral_interaction))\ncolnames(all_viral_interaction) = gsub(\"\\\\(|\\\\)\",\"\",colnames(all_viral_interaction))\ncolnames(all_viral_interaction) = gsub(\"#\",\"\",colnames(all_viral_interaction))\n}\n# cleaning Taxid \"taxid:9606(human)|taxid:9606(Homo sapiens)\" to 9606\n{\nall_viral_interaction[, Taxid_interactor_A := gsub(\"taxid:|\\\\(.*$\",\"\",Taxid_interactor_A)]\nall_viral_interaction[, Taxid_interactor_B := gsub(\"taxid:|\\\\(.*$\",\"\",Taxid_interactor_B)]\nall_viral_interaction[, Host_organisms := gsub(\"taxid:|\\\\(.*$\",\"\",Host_organisms)]\n# saving identifier types and cleaning interactor ids\nall_viral_interaction[, interactor_IDs_databases_A := gsub(\":.*$\",\"\",IDs_interactor_A)]\nall_viral_interaction[, interactor_IDs_databases_B := gsub(\":.*$\",\"\",IDs_interactor_B)]\nall_viral_interaction[, IDs_interactor_A := gsub(\"^.*:\",\"\",IDs_interactor_A)]\nall_viral_interaction[, IDs_interactor_B := gsub(\"^.*:\",\"\",IDs_interactor_B)]\n# cleaning other information\nall_viral_interaction[, bait_prey_status_A := gsub(\"^.*\\\\(|\\\\)\",\"\",Experimental_roles_interactor_A)]\nall_viral_interaction[, bait_prey_status_B := gsub(\"^.*\\\\(|\\\\)\",\"\",Experimental_roles_interactor_B)]\nall_viral_interaction[, Publication_Identifiers := gsub(\"^.*pubmed:|\\\\|.*$\",\"\",Publication_Identifiers)]\nall_viral_interaction[, Confidence_values := gsub(\"^intact-miscore:\",\"\",Confidence_values)]\nall_viral_interaction[, Confidence_values := gsub(\"-\",\"NA\",Confidence_values)]\nall_viral_interaction[, Confidence_values := as.numeric(Confidence_values)]\n#all_viral_interaction[, Interaction_identifiers := unlist(gsubfn::strapplyc(Interaction_identifiers,\"EBI-[[:digit:]]+\",simplify = T)), by =Interaction_identifiers]\n# generating unique identifier for interacting pairs\nall_viral_interaction[, pair_id := apply(data.table(IDs_interactor_A,IDs_interactor_B,stringsAsFactors = F), 1,\n                                               function(a) { z = sort(a)\n                                               paste0(z[1],\"_\",z[2]) })]\nall_viral_interaction[, pair_species_id := apply(data.table(Taxid_interactor_A,Taxid_interactor_B,stringsAsFactors = F), 1,\n                                               function(a) { z = sort(a)\n                                               paste0(z[1],\"_\",z[2]) })]\n}\n\n# filter only human-viral interactions\nall_viral_interaction = all_viral_interaction[Taxid_interactor_A == \"9606\" | Taxid_interactor_B == \"9606\",]\n\n## function to remove any isoform \"-1\" XXXXXX-1 from IDs\nisoform_id_all_remover <- function(isoform_ids) {\n  temp = gsub(\"-[[:digit:]]+$\",\"\",isoform_ids)\n  # remove peptide ids\n  # gsub(\"-PRO_[[:digit:]]+$\",\"\",temp)\n}\n# convert to canonical identifiers with exception to peptide ids XXXXXX-PRO_\nall_viral_interaction[, IDs_interactor_A_clean := isoform_id_all_remover(IDs_interactor_A)]\nall_viral_interaction[, IDs_interactor_B_clean := isoform_id_all_remover(IDs_interactor_B)]\n\n# select species, proteins\nspecies_id = all_viral_interaction[, unique(c(Taxid_interactor_A, Taxid_interactor_B))]\nspecies_id = species_id[-which(species_id == \"9606\")]\nviral_proteins = unique(c(all_viral_interaction[Taxid_interactor_A != \"9606\", IDs_interactor_A_clean], all_viral_interaction[Taxid_interactor_B != \"9606\", IDs_interactor_B_clean]))\nhuman_proteins = unique(c(all_viral_interaction[Taxid_interactor_A == \"9606\", IDs_interactor_A_clean], all_viral_interaction[Taxid_interactor_B == \"9606\", IDs_interactor_B_clean]))\n```\n\n```{r, results='hide'}\n#find species names\nif(!file.exists(\"./source_files/viral_species_names.txt\")){\nspecies_names = data.table()\nfor(specie in species_id){\n      species_names_temp = fread(paste0(\"http://www.uniprot.org/uniprot/?compress=no&query=organism:\",specie,\"&fil=&force=no&format=tab&columns=organism,organism-id\"), stringsAsFactors = F)\n      species_names = rbind(species_names, unique(species_names_temp))\n}\nfwrite(species_names,\"./source_files/viral_species_names.txt\", sep = \"\\t\")\n}\nspecies_names = fread(\"./source_files/viral_species_names.txt\", colClasses = \"character\",stringsAsFactors = F)\n```\n\nI get domains from InterPro. \n\n```{r get_interpro}\nget_interpro = function(){\n# Downloading UniprotID to InterPro, gz-unzipping, splitting file into many small files\nurl_interpro = \"ftp://ftp.ebi.ac.uk/pub/databases/interpro/protein2ipr.dat.gz\"\nfilename_interpro = paste0(\"./source_files/protein2ipr_release_\", format(Sys.Date(), \"%m-%Y.dat.gz\"))\nfilename_interpro1 = substr(filename_interpro, 1, nchar(filename_interpro)-3)\nfilename_interpro2 = substr(filename_interpro, 1, nchar(filename_interpro)-7)\n#\nif(!(length(list.files(filename_interpro2)) > 0)) {\n  # Downloading UniprotID to InterPro\n  downloader::download(url_interpro, filename_interpro)\n  # gz-unzipping UniprotID to InterPro\n  system(paste(\"gunzip\", filename_interpro))\n  # splitting file into many 5-million-line files\n  system(paste(\"mkdir\", filename_interpro2))\n  system(paste0(\"split -l 5000000 \", \n                filename_interpro1,\" \",\n                filename_interpro2,\"/\"))\n}\nfilename_interpro3 = list.files(filename_interpro2)\n# returns the vector of paths to interpro files\nreturn(paste0(filename_interpro2, \"/\",filename_interpro3))\n}\n\nproteins2domains = function(proteins, interpro_files){\n  domains = data.table::data.table()\n  for(file in interpro_files){\n    interpro = data.table::fread(file = file, colClasses = \"character\", stringsAsFactors = F, header = F, sep = \"\\t\")\n    domains = rbind(domains, interpro[V1 %in% proteins,])\n  }\n  setnames(domains, names(domains), c(\"UniprotID\", \"InterProID\", \"Description\", \"DomainID\", \"start\", \"stop\"))\n  return(domains)\n}\n\ndomains2proteins = function(domains, interpro_files){\n  proteins = data.table::data.table()\n  for(file in interpro_files){\n    interpro = data.table::fread(file = file, colClasses = \"character\", stringsAsFactors = F, header = F, sep = \"\\t\")\n    proteins = rbind(proteins, interpro[V2 %in% domains,])\n  }\n  setnames(proteins, names(proteins), c(\"UniprotID\", \"InterProID\", \"Description\", \"DomainID\", \"start\", \"stop\"))\n  return(proteins)\n}\n\ninterpro_files = get_interpro()\nif(!file.exists(\"./processed_files/human_domains\")){\n      human_domains = proteins2domains(human_proteins, interpro_files)\n      fwrite(human_domains, \"./processed_files/human_domains\")\n}\nhuman_domains = fread(\"./processed_files/human_domains\", colClasses = \"character\", stringsAsFactors = F, header = T, sep = \",\")\n\n#if(!file.exists(\"./processed_files/human_protein_with_domains\")){\n#      human_protein_with_domains = domains2proteins(human_domains$InterProID,interpro_files)\n#      fwrite(human_protein_with_domains, \"./processed_files/human_protein_with_domains\")\n#}\n#human_protein_with_domains = fread(\"./processed_files/human_protein_with_domains\", colClasses = \"character\", stringsAsFactors = F, header = T, sep = \",\")\n```\n\nThere are `r nrow(unique(human_domains[,.(UniprotID,InterProID)]))` protein-domain pairs for human proteins which interact with viral proteins. `r nrow(unique(human_domains[,.(UniprotID)]))` proteins, `r nrow(unique(human_domains[,.(InterProID)]))` domains (or families). InterPro doesn't allow to easily distinguish between them (only through XML).   \n\nThe pipeline uses canonical proteins indentifiers for human proteins (InterPro domains are mapped to canonical UniprotKB indentifiers) but accounts for isoforms and peptides in viral proteins.  \n\n```{r unique_interactions}\nall_viral_interaction_ab = all_viral_interaction[Taxid_interactor_A == \"9606\" & Taxid_interactor_B != \"9606\", .(IDs_interactor_A = IDs_interactor_A_clean, IDs_interactor_B, Taxid_interactor_A, Taxid_interactor_B)]\nall_viral_interaction_ba = all_viral_interaction[Taxid_interactor_A != \"9606\" & Taxid_interactor_B == \"9606\", .(IDs_interactor_A = IDs_interactor_B_clean, IDs_interactor_B = IDs_interactor_A, Taxid_interactor_A = Taxid_interactor_B, Taxid_interactor_B = Taxid_interactor_A)]\nall_viral_interaction_simp = unique(rbind(all_viral_interaction_ab, all_viral_interaction_ba))\n```\n\n# 1 Number of viral proteins per human domain (no overrepresentation analysis)   \n\n```{r human_domains_for_viral_proteins}\ncolnames(human_domains)[1] = \"IDs_interactor_A\"\ndomains_viral_interactions = copy(unique(all_viral_interaction_simp[human_domains[,.(IDs_interactor_A,InterProID)], on = \"IDs_interactor_A\", allow.cartesian = T]))\ndomains_viral_interactions[, viral_proteins_per_human_domain := length(unique(IDs_interactor_B)), by = InterProID]\n\nggplot(unique(domains_viral_interactions[,.(InterProID,viral_proteins_per_human_domain)]), aes(x = viral_proteins_per_human_domain)) + geom_histogram() +\n    ggtitle(paste0(\"the number of viral proteins per human domain (\",length(unique(domains_viral_interactions[,InterProID])),\" total) \\n(no domain overrepresentation analysis), max: \",max(domains_viral_interactions$viral_proteins_per_human_domain)))+\n        theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n              panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n        scale_x_log10(breaks = c(1,5,6,7,2^c(1:8), 3^c(1:3)))+ \n        scale_y_continuous(breaks = seq(0,1600, 50))+\n    xlab(\"viral proteins per human domain\")\n```\n\n\n# 2 Permutation test performed to identify over-represented human domains for each interacting viral protein produces weird p-value distribution\n\n```{r permut, fig.width=8,fig.height=6}\ndomains_viral_interactions = unique(domains_viral_interactions)\ndomain_count = copy(domains_viral_interactions)[, .(viral_interacting_human_proteins_with_specific_domain = length(unique(IDs_interactor_A)), random = \"no\"), by = .(IDs_interactor_B, InterProID)]\nset.seed(1)\nrandom_sample = copy(domains_viral_interactions)[, InterProID := sample(InterProID)][, .(viral_interacting_human_proteins_with_specific_domain = length(unique(IDs_interactor_A)), random = \"yes\"), by = .(IDs_interactor_B, InterProID)]\n\nrepres = rbind(domain_count, random_sample)\n\nggplot(repres, aes(x = viral_interacting_human_proteins_with_specific_domain, color = as.factor(random))) + geom_freqpoly() +\n    ggtitle(paste0(\"the number of human proteins containing specific domain \\nand interacting with specific viral protein (\",length(unique(domain_count[,IDs_interactor_B])),\" viral proteins total), max: \",max(domain_count$viral_interacting_human_proteins_with_specific_domain)))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_log10(breaks = 2^c(1:8))+ scale_y_log10(breaks = 2^c(1:12))+\n    xlab(\"human proteins with a specific domain per viral protein\")\n\n# permutations: 1000 takes about 6-7 minutes\nif(!file.exists(\"./processed_files/human_domains_pval\")){\n    set.seed(1)\n    domain_count[, permutation_result := {\n        rowSums(replicate(10, {\n            rowSums(replicate(1000, {\n                x = copy(domains_viral_interactions)[, InterProID := sample(InterProID)][, .(sample = length(unique(IDs_interactor_A))), by = .(IDs_interactor_B, InterProID)]\n                x = x[domain_count[,.(IDs_interactor_B,InterProID, viral_interacting_human_proteins_with_specific_domain)], on = c(\"IDs_interactor_B\", \"InterProID\"),]\n                x[is.na(sample), sample := 0][, sample < viral_interacting_human_proteins_with_specific_domain]\n            }))\n        }))\n    }]\n    fwrite(domain_count, \"./processed_files/human_domains_pval\", sep = \"\\t\")\n}\ndomain_count = fread(\"./processed_files/human_domains_pval\", colClasses = c(\"character\",\"character\",\"numeric\",\"character\",\"numeric\"), stringsAsFactors = F, header = T, sep = \"\\t\")\n\ndomain_count[, permutation_pval := 1 - permutation_result/(10*1000)]\ndomain_count = domain_count[IDs_interactor_B != \"\" & InterProID != \"\",]\n\n# plotting the distributions of resulting pvalues\nggplot(domain_count, aes(x = permutation_pval)) + geom_histogram(bins = 100) +\n    ggtitle(paste0(\"Permutation pvalue distribution: \\nis a specific domain enriched among human interactors of a particular viral protein\"))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_continuous(breaks = seq(0,1,0.05))+\n    xlab(\"permutation pvalue\")\n```\n\nCorrecting p-values for multiple hypothesis testing using q-value approach.\nMay not be appropriate considering how different the distribution of p-values is from uniform.\nPlot below shows pi and lamda used in calculating q-value, how pvalue is converted to qvalue and other data.  \n\n```{r adjusting_pval}\npvals = domain_count$permutation_pval\nnames(pvals) = paste0(domain_count$IDs_interactor_B, \"_\", domain_count$InterProID)\n\nqvals_out = qvalue(domain_count$permutation_pval)\n\nplot(qvals_out)\n```\n\n`r sum(qvals_out$qvalues < 0.01)` viral protein - human domain associations have lower than p = 0.05 probability of being identified by chance (qvalue corrected). \n\n\n\n# 3 Binging similarity as an explanation for weird p-value distribution\n\nViral proteins represent very specific subset of the human interactome. We generate the null distribution permuting which viral proteins interact with which human proteins. Binding preferrences of viral proteins with respect to specific human domains may be one of the factors contributing to the skew in null distribution that we observe. In the other words, this network may have higher fraction of the true positives than we would expect.   \n\n## Viral protein binding similarity (based on the overlap in human domains they bind, kappa score)\n\nKappa score is a way of measuring categorical similarity. Here kappa score is converted to distance (1 - kappa score). The more similar proteins or domains are the lower the score (red on the heatmap). Kappa score is calculated as described in [DAVID tool paper from 2007](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2375021/figure/F2/).   \nIn this plot, all viral proteins are compared by which InterPro features are present in human proteins that they interact with.  \n\n```{r similarity_between_viral_proteins, fig.width=12, fig.height=12}\n# change `-` to `.` to avoid problems with data.table\ndomain_count[, IDs_interactor_B := gsub(\"-\",\".\",IDs_interactor_B)]\nif(!file.exists(\"./processed_files/viral_protein_similarity\")){\n    viral_protein_similarity = categ_dist(domain_count[,.(InterProID, IDs_interactor_B)], ignore_limit = T)\n    save(viral_protein_similarity, file = \"./processed_files/viral_protein_similarity\")\n}\nload(\"./processed_files/viral_protein_similarity\")\n\nheatmap.2(1-viral_protein_similarity$similarity_matrix,\n           distfun = function(x){as.dist(x)}, \n           trace = \"none\")\n```\n\n\n\n```{r similarity_between_domains, eval=FALSE, fig.width=12, fig.height=12}\n## human domain binding similarity (based on the overlap in viral protein they bind, kappa score) - all\nif(!file.exists(\"./processed_files/domain_similarity\")){\ndomain_similarity = categ_dist(domain_count[,.(IDs_interactor_B,InterProID)], ignore_limit = T)\n    save(domain_similarity, file = \"./processed_files/domain_similarity\")\n}\nload(\"./processed_files/domain_similarity\")\n\nheatmap.2(1-domain_similarity$similarity_matrix,\n           distfun = function(x){as.dist(x)}, \n           trace = \"none\")\n```\n\n\n\n# 4 Viral proteins with only a few known interacting partners as an explanation for weird p-value distribution\n\n```{r}\ndomains_viral_interactions[, degree_interactor_B := length(unique(IDs_interactor_A)), by = IDs_interactor_B]\ndomain_count = domain_count[unique(domains_viral_interactions[,.(IDs_interactor_B, degree_interactor_B)]), on = \"IDs_interactor_B\"]\n\nrf <- colorRampPalette(rev(brewer.pal(11,'Spectral')))\nr <- rf(32)\n\nggplot(unique(domain_count[,.(IDs_interactor_B,InterProID,degree_interactor_B,permutation_pval)]), aes(x = degree_interactor_B, y = permutation_pval)) + stat_bin2d(bins=25)+\n    ggtitle(\"p-value tends to be higher the more interactions viral protein has overal\")+\n        theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n              panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n        scale_x_log10(breaks = 2^c(1:8))+ \n        scale_y_log10(breaks = 10^c(0:-8),\n                labels = trans_format(\"log10\", math_format(10^.x)))+\n    xlab(\"viral protein degree\") + scale_fill_gradientn(colours=r)\n\nggplot(unique(domain_count[,.(IDs_interactor_B,InterProID,viral_interacting_human_proteins_with_specific_domain,permutation_pval)]), aes(x = viral_interacting_human_proteins_with_specific_domain, y = permutation_pval)) + stat_bin2d(bins=25) +\n    ggtitle(\"large fraction of p < 0.05 (below the line) come \\nfrom 'single viral protein' - 'single human domain' associations\")+\n        theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n              panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n        scale_x_log10(breaks = 2^c(1:8))+ \n        scale_y_log10(breaks = c(10^c(0:-8), 0.05),\n                labels = trans_format(\"log10\", math_format(10^.x)))+ geom_hline(yintercept = 0.05)+\n    xlab(\"the number of human proteins with a specific domain per viral protein\") + scale_fill_gradientn(colours=r)\n```\n\nP-value indeed depends on the number of \"viral protein\"-\"human domain\" interactions. We need to filter those out either from the permutation data already generated (section 5) or remove single \"viral protein\"-\"human domain\" interactions from the networks before permutation test (section 6).\n\n# 5 Filter out 'viral protein'-'human domain' interactions when there is less than 4 human proteins with a specific domain per viral protein (after permutation analysis performed earlier)\n\n```{r}\ndomain_count_filtered = domain_count[viral_interacting_human_proteins_with_specific_domain >= 4,]\npvals = domain_count_filtered[, permutation_pval]\nnames(pvals) = paste0(domain_count_filtered$IDs_interactor_B, \"_\", domain_count_filtered$InterProID)\n\nqvals_out = qvalue(pvals)\n\nplot(qvals_out)\n\nqplot(qvals_out$qvalues) + geom_histogram(bins = 40) +\n    ggtitle(paste0(\"Permutation pvalue distribution: \\nis a specific domain enriched among human interactors of a particular viral protein\"))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_continuous(breaks = seq(0,1,0.05))+\n    xlab(\"permutation qvalue\")\n```\n\n  \n  \n\n# 6 Repeat permutation test while removing 'viral protein'-'human domain' interactions when there is less than 4 human proteins with a specific domain per viral protein\n\n```{r filter4_permut, fig.width=8,fig.height=6}\ndomains_viral_interactions = unique(domains_viral_interactions)\ndomain_count_filter4 = copy(domains_viral_interactions)[, .(viral_interacting_human_proteins_with_specific_domain = length(unique(IDs_interactor_A)), random = \"no\"), by = .(IDs_interactor_B, InterProID)][viral_interacting_human_proteins_with_specific_domain >= 4,]\nset.seed(1)\nrandom_sample_filter4 = copy(domains_viral_interactions)[, InterProID := sample(InterProID)][, .(viral_interacting_human_proteins_with_specific_domain = length(unique(IDs_interactor_A)), random = \"yes\"), by = .(IDs_interactor_B, InterProID)][viral_interacting_human_proteins_with_specific_domain >= 4,]\n\nrepres = rbind(domain_count_filter4, random_sample_filter4)\n\nggplot(repres, aes(x = viral_interacting_human_proteins_with_specific_domain, color = as.factor(random))) + geom_freqpoly() +\n    ggtitle(paste0(\"the number of human proteins containing specific domain \\nand interacting with specific viral protein (\",length(unique(domain_count_filter4[,IDs_interactor_B])),\" viral proteins total), max: \",max(domain_count_filter4$viral_interacting_human_proteins_with_specific_domain)))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_log10(breaks = 2^c(1:8))+ scale_y_log10(breaks = 2^c(1:12))+\n    xlab(\"human proteins with a specific domain per viral protein\")\n\ndomains_viral_interactions_filter4 = domains_viral_interactions[IDs_interactor_B %in% domain_count_filter4$IDs_interactor_B & InterProID %in% domain_count_filter4$InterProID,]\n# permutations: 1000 takes about 6-7 minutes\nif(!file.exists(\"./processed_files/human_domains_pval_filter4\")){\n    set.seed(1)\n    domain_count_filter4[, permutation_result := {\n        rowSums(replicate(10, {\n            rowSums(replicate(1000, {\n                x = copy(domains_viral_interactions_filter4)[, InterProID := sample(InterProID)][, .(sample = length(unique(IDs_interactor_A))), by = .(IDs_interactor_B, InterProID)]\n                x = x[domain_count_filter4[,.(IDs_interactor_B,InterProID, viral_interacting_human_proteins_with_specific_domain)], on = c(\"IDs_interactor_B\", \"InterProID\"),]\n                x[is.na(sample), sample := 0][, sample < viral_interacting_human_proteins_with_specific_domain]\n            }))\n        }))\n    }]\n    fwrite(domain_count_filter4, \"./processed_files/human_domains_pval_filter4\", sep = \"\\t\")\n}\ndomain_count_filter4 = fread(\"./processed_files/human_domains_pval_filter4\", colClasses = c(\"character\",\"character\",\"numeric\",\"character\",\"numeric\"), stringsAsFactors = F, header = T, sep = \"\\t\")\n\ndomain_count_filter4[, permutation_pval := 1 - permutation_result/(10*1000)]\ndomain_count_filter4 = domain_count_filter4[IDs_interactor_B != \"\" & InterProID != \"\",]\n\n# plotting the distributions of resulting pvalues\nggplot(domain_count_filter4, aes(x = permutation_pval)) + geom_histogram(bins = 100) +\n    ggtitle(paste0(\"Permutation pvalue distribution: \\nis a specific domain enriched among human interactors of a particular viral protein\"))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_continuous(breaks = seq(0,1,0.05))+\n    xlab(\"permutation pvalue\")\n```\n\n```{r qvalue2}\npvals_filter4 = domain_count_filter4[, permutation_pval]\nnames(pvals_filter4) = paste0(domain_count_filter4$IDs_interactor_B, \"_\", domain_count_filter4$InterProID)\n\nqvals_filter4_out = qvalue(pvals_filter4)\n\nplot(qvals_filter4_out)\n\nqplot(qvals_filter4_out$qvalues) + geom_histogram(bins = 40) +\n    ggtitle(paste0(\"Permutation qvalue distribution: \\nis a specific domain enriched among human interactors of a particular viral protein\"))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_continuous(breaks = seq(0,1,0.01))+\n    xlab(\"permutation qvalue\")\n```\n\n```{r bonferroni}\ndomain_count_filter4[, permutation_pval_adj := p.adjust(permutation_pval,\"bonferroni\")]\nqplot(domain_count_filter4[, permutation_pval_adj]) + geom_histogram(bins = 40) +\n    ggtitle(paste0(\"Permutation pvalue (bonferroni corrected) distribution: \\nis a specific domain enriched among human interactors of a particular viral protein\"))+\n    theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n          panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n    scale_x_continuous(breaks = seq(0,1,0.05))+\n    xlab(\"permutation pvalue (bonferroni corrected)\")\n```\n\n# 7 Different viral proteins share domains in human proteins   \n\n### Viral protein binding similarity (based on the overlap in human domains they bind, kappa score) - significant pairs after bonferroni correction  \n\n```{r similarity_between_viral_proteins2, fig.width=12, fig.height=12}\nif(!file.exists(\"./processed_files/viral_protein_similaritysignificant\")){\nviral_protein_similaritysignificant = categ_dist(domain_count_filter4[,.(InterProID, IDs_interactor_B)],terms_to_compare = domain_count_filter4[p.adjust(domain_count_filter4[, permutation_pval],\"bonferroni\") < 0.05, unique(IDs_interactor_B)], ignore_limit = T)\n    save(viral_protein_similaritysignificant, file = \"./processed_files/viral_protein_similaritysignificant\")\n}\nload(\"./processed_files/viral_protein_similaritysignificant\")\n\nheatmap.2(1-viral_protein_similaritysignificant$similarity_matrix,\n           distfun = function(x){as.dist(x)}, \n           trace = \"none\")\n```\n\n# 8 Different human domains share viral proteins  \n\n### Human domain binding similarity (based on the overlap in viral proteins they bind, kappa score) - significant pairs after bonferroni correction  \n\n```{r similarity_between_domains2, fig.width=12, fig.height=12}\nif(!file.exists(\"./processed_files/domain_similaritysignificant\")){\ndomain_similaritysignificant = categ_dist(domain_count_filter4[,.(IDs_interactor_B,InterProID)],terms_to_compare =  domain_count_filter4[p.adjust(domain_count_filter4[, permutation_pval],\"bonferroni\") < 0.05, unique(InterProID)], ignore_limit = T)\n    save(domain_similaritysignificant, file = \"./processed_files/domain_similaritysignificant\")\n}\nload(\"./processed_files/domain_similaritysignificant\")\n\nheatmap.2(1-domain_similaritysignificant$similarity_matrix,\n           distfun = function(x){as.dist(x)}, \n           trace = \"none\")\n```\n\n# 9 Number of viral proteins per human domain (after overrepresentation analysis)   \n\n```{r human_domains_for_viral_proteins_signif}\ndomain_count_filter4[, viral_proteins_per_human_domain := length(unique(IDs_interactor_B)), by = InterProID]\n\nggplot(unique(domain_count_filter4[,.(InterProID,viral_proteins_per_human_domain)]), aes(x = viral_proteins_per_human_domain)) + geom_histogram() +\n    ggtitle(paste0(\"the number of viral proteins per unique human domain (\",length(unique(domain_count_filter4[,InterProID])),\" domains total) \\n(after the domain overrepresentation analysis), max: \",max(domain_count_filter4$viral_proteins_per_human_domain),\" proteins\"))+\n        theme(panel.grid.major =  element_line(color = 'grey', size = 0.2, linetype = 'solid'),\n              panel.background = element_rect(fill = '#FFFFFF', colour = 'grey')) + \n        scale_x_log10(breaks = c(1,5,6,7,2^c(1:8), 3^c(1:8)))+ \n        scale_y_continuous(breaks = seq(0,100, 5))+\n    xlab(\"viral proteins per human domain\")\n```\n\n\nThe simplest experiment to confirm these result would be to look for human proteins which have viral-interacting domain but have not been detected interacting with the corresponding viral protein.  \n\n# 10 Results in an interactive table\n\n```{r domain_count_filter4_view}\ndomain_protein = unique(domain_count_filter4[permutation_pval_adj < 0.05,][copy(human_domains[,.(InterProID,Description)]), on = \"InterProID\", allow.cartesian = T, nomatch = 0][, c(\"permutation_result\",\"random\") := NULL][,permutation_pval_adj:= signif(permutation_pval_adj,2)][,permutation_pval:= signif(permutation_pval,2)])\ndomain_protein = domain_protein[all_viral_interaction[,.(IDs_interactor_B = c(IDs_interactor_A,IDs_interactor_B), Taxid = c(Taxid_interactor_A,Taxid_interactor_B))], on =\"IDs_interactor_B\", nomatch = 0] #features = c(Features_interactor_A, Features_interactor_B)\ncolnames(species_names) = c(\"Organism\",\"Taxid\")\ndomain_protein = unique(copy(domain_protein[species_names, on = \"Taxid\", nomatch = 0]))\ncolnames(domain_protein)\ncolnames(domain_protein)[1] = \"viral protein ID (interactor_B)\"\ncolnames(domain_protein)[2] = \"human domain ID (InterProID)\"\ncolnames(domain_protein)[3] = \"N human proteins with InterProID domain interacting with interactor B\"\ncolnames(domain_protein)[6] = \"viral proteins per InterProID domain (human)\"\ncolnames(domain_protein)[7] = \"InterProID domain decription\"\ndatatable(domain_protein)\n```",
    "created" : 1498142041982.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1302053104",
    "id" : "AAE7C97D",
    "lastKnownWriteTime" : 1498142121,
    "last_content_update" : 1498142121500,
    "path" : "~/Desktop/toggle_switches/viral_protein_human_domain_interaction.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}