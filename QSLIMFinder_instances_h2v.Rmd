---
title: 'QSLIMFinder: domain instances, human to search, viral to filter'
author: "Vitalii Kleshchevnikov"
date: "04/09/2017"
output: 
  html_document: 
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages = c("MItools", "rtracklayer", "R.utils", "ontologyIndex")
if(mean(packages %in% names(installed.packages()[,"Package"])) != 1){
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    # specifying mirror is necessary for some Linux systems
    install.packages(packages_to_install, dependencies = T, repos = "http://mirrors.ebi.ac.uk/CRAN/")
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    source("https://bioconductor.org/biocLite.R")
    biocLite(packages_to_install)
    devtools::install_github("vitkl/MItools", dependencies = T)
}

suppressPackageStartupMessages({
    library(MItools)
    library(rtracklayer)
})
```

## use all the interacting partners of human proteins with significant domains to seach for motifs and their viral interactors to filter

QSLIMfinder options: 
- seqin - all the interacting partners of human proteins with significant domains (including viral proteins); FASTA sequences
- query - the viral interacting partners of human proteins with significant domains; names of the FASTA sequences in seqin
- resdir - directory where to store all results
- resfile - file where to write
- dismask - mask disordered regions using IUPRED
- consmask - relative conservation masking
- probcut - FDR-corrected probability cutoff
- qregion - Mask all but the region of the query from (and including) residue X to residue Y [0,-1] (useful for regions sufficient/necessary to interact)

## load PPI data

```{r load_data}
# load ppi data
IntAct = loadIntActFTP(dir = "./data_files/IntActRelease_2017Nov13/", release = "2017Nov13")
# human-human
all_human_interaction = fullInteractome(taxid = 9606, database = "IntActFTP", format = "tab27",
                                        clean = TRUE, protein_only = TRUE,
                                        MITABdata = IntAct, directory = "./data_files/",
                                        releaseORdate = "2017Nov13")
# human-viral
all_viral_interaction = interSpeciesInteractome(taxid1 = 9606, taxid2 = 10239, database = "IntActFTP", format = "tab27",
                                                clean = TRUE, protein_only = TRUE,
                                                MITABdata = IntAct, directory = "./data_files/",
                                                releaseORdate = "2017Nov13")

dataset_name = "Full_IntAct2" # refer to MItools::mBenchmarkMotifs
SLIMFinder_dir = paste0("./",dataset_name,"/")
LSF_project_path = "/hps/nobackup/research/petsalaki/users/vitalii/vitalii/viral_project/"
analysis_type = "qslimfinder" # or "slimfinder"
options = "dismask=T consmask=F cloudfix=T probcut=0.3 iuchdir=T"
software_path = "../software/cluster/" # "../software/"
write_log = T
```

## load results of which domains are likely to mediate interaction
```{r load_results}
# load the domain analysis results
load("./processed_data_files/what_we_find_VS_ELM_clust20171019.RData")
domain_res = res_count
rm(list = ls()[!ls() %in% c("domain_res", "all_human_interaction", "all_viral_interaction", "dataset_name", "SLIMFinder_dir", "LSF_project_path", "analysis_type", "options", "software_path", "write_log")])

# choose pvalue cutoff:
plot(domain_res)
proteins_w_signif_domains = unique(domain_res$data_with_pval[p.value <= 1, IDs_interactor_human])
#proteins_w_signif_domains = extractInteractors(all_viral_interaction, taxid = 9606, inverse_filter = T)
```

### prepare sets of protein sequences and instructions for SLIMFinder

```{r prepare_FASTA_for_QSLIMFinder}
# load FASTA
all.fasta = readAAStringSet(filepath = "./data_files/all_human_viral_proteins.fasta", format = "fasta")

# remove interactions if one of the interactors does not have a FASTA sequence
all_human_interaction = removeInteractionNoFASTA(all_human_interaction, all.fasta)
all_viral_interaction = removeInteractionNoFASTA(all_viral_interaction, all.fasta)

forSLIMFinder = listInteractionSubsetFASTA(interaction_set1 = all_human_interaction, 
                                           interaction_set2 = all_viral_interaction, 
                                           seed_id_vect = proteins_w_signif_domains,
                                           fasta = all.fasta,
                                           single_interact_from_set2 = T, set1_only = F)

forSLIMFinder_Ready = filterInteractionSubsetFASTA_list(forSLIMFinder,  length_set1_min = 2, length_set2_min = 1)
# how many viral-human pairs in which viral proteins interact with human protein (with relevant domain) but are not associated with the domain
sum(!domainProteinPairMatch(forSLIMFinder_Ready, domain_res, remove = F))
# how many viral-human pairs in which viral proteins interact with human protein (with relevant domain) and are associated with the domain
sum(domainProteinPairMatch(forSLIMFinder_Ready, domain_res, remove = F))
# total
forSLIMFinder_Ready$length

#filter
domain_filt = domain_res
domain_filt$data_with_pval = domain_filt$data_with_pval[p.value <= 1,]
forSLIMFinder_Ready = domainProteinPairMatch(forSLIMFinder_Ready, domain_filt, remove = T)
```

## Generate bash commands to run QSLIMFinder

```{r save}
if(!dir.exists(SLIMFinder_dir)) dir.create(SLIMFinder_dir)

forSLIMFinder_file_list = writeInteractionSubsetFASTA_list(interactionFASTA_list = forSLIMFinder_Ready,
                                                           dir = SLIMFinder_dir, analysis_type = analysis_type)

QSLIMFinderCommand(file_list = forSLIMFinder_file_list, 
                                   slimpath = paste0(software_path, "slimsuite/tools/"), 
                                   blast = paste0(software_path, "ncbi_blast_2.6.0/bin/"), 
                                   iupred = paste0(software_path, "iupred/iupred"),
                                   options = options,
                                   LSF_project_path = LSF_project_path,
                                   LSF_cluster_par = "bsub -n 1 -q research-rh7 -M 100 -R \"rusage[mem=100]\"",
                                   analysis_type = analysis_type)

all_commands = mQSLIMFinderCommand(file_list = forSLIMFinder_file_list, 
                                   slimpath = paste0(software_path, "slimsuite/tools/"), 
                                   blast = paste0(software_path, "ncbi_blast_2.6.0/bin/"), 
                                   iupred = paste0(software_path, "iupred/iupred"),
                                   options = options,
                                   LSF_cluster_mode = T,
                                   LSF_project_path = LSF_project_path,
                                   LSF_cluster_par = "bsub -n 1 -q research-rh7 -M 100 -R \"rusage[mem=100]\"",
                                   analysis_type = analysis_type,
                                   write_log = write_log,
                                   log_dir = paste0(SLIMFinder_dir, "log_dir/"))
#all_commands = groupQSLIMFinderCommand(commands = all_commands,
#                                      InteractionSubsetFASTA_list = forSLIMFinder_Ready,
#                                       sh_dir = "/sh_dir/",
#                                       LSF_project_path = LSF_project_path,
#                                       dataset_name = dataset_name, N_seq = 200, write_log = write_log)
```

## Run QSLIMFinder

```{r run}
#if(tryCatch({system("bjobs", intern = T)}, error = function(e) e)$message != "error in running command") onLSF = T else onLSF = F
runQSLIMFinder(commands_list = all_commands, file_list = forSLIMFinder_file_list, onLSF = T)
```

## Read results

```{r read}
resultdir = paste0(SLIMFinder_dir, "result/")
if(!dir.exists(resultdir)) dir.create(resultdir)
QSLIMFinder_main_result = readQSLIMFinderMain(outputfile = forSLIMFinder_file_list$outputfile)
QSLIMFinder_occurence = readQSLIMFinderOccurence(outputdir = forSLIMFinder_file_list$outputdir)
fwrite(QSLIMFinder_main_result, paste0(resultdir, "main_result.txt"), sep = "\t")

fwrite(QSLIMFinder_occurence, paste0(resultdir, "occurence.txt"), sep = "\t")
writePatternList(QSLIMFinder_main_result, filename = paste0(resultdir, "motifs.txt"))
```

## Compare motifs to ELM

```{r comparimotif}
runCompariMotif3(input_file = paste0(resultdir, "motifs.txt"),
                 slimpath = paste0(software_path, "slimsuite/tools/"),
                 run = T, with = "db",
                 out_file = paste0(resultdir, "comparimotif.tdt"))
runCompariMotif3(input_file = paste0(resultdir, "motifs.txt"),
                 slimpath = paste0(software_path, "slimsuite/tools/"),
                 run = T, with = "self",
                 out_file = paste0(resultdir, "comparimotif_with_self.tdt"))
#R.utils::gzip(paste0(resultdir, "comparimotif_with_self.compare.tdt"), paste0(resultdir, "comparimotif_with_self.compare.tdt.gz"))
#R.utils::gzip(paste0(resultdir, "comparimotif_with_self.compare.xgmml"), paste0(resultdir, "comparimotif_with_self.compare.xgmml.gz"))
```

```{r}
tar(paste0(SLIMFinder_dir, "input.gz"),paste0(SLIMFinder_dir, "input/"), compression='gzip')
#tar(paste0(SLIMFinder_dir, "log_dir.gz"),paste0(SLIMFinder_dir, "log_dir/"), compression='gzip')
#tar(paste0(SLIMFinder_dir, "output.gz"),paste0(SLIMFinder_dir, "output"), compression='gzip')
unlink(paste0(SLIMFinder_dir, "input/"), recursive = T)
#unlink(paste0(SLIMFinder_dir, "log_dir/"))
#unlink(paste0(SLIMFinder_dir, "output/"))
filename = paste0("./processed_data_files/QSLIMFinder_instances_h2v_",dataset_name,"_clust",format(Sys.Date(), "%Y%m"),".RData")
save(list = ls(), file=filename)
Sys.Date()
sessionInfo()
```
