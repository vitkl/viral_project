---
title: "Comprehensive benchmarking of motif instances (all types)"
author: "Vitalii Kleshchevnikov"
date: "18/10/2017"
output: 
  html_document: 
    keep_md: yes
    toc: yes
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 12, fig.height = 8, warning = FALSE, message = FALSE)

packages = c("MItools", "RColorBrewer", "devtools")
if(mean(packages %in% names(installed.packages()[,"Package"])) != 1){
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    # specifying mirror is necessary for some Linux systems
    install.packages(packages_to_install, dependencies = T, repos = "http://mirrors.ebi.ac.uk/CRAN/")
    packages_to_install = packages[!packages %in% names(installed.packages()[,"Package"])]
    source("https://bioconductor.org/biocLite.R")
    biocLite(packages_to_install)
    devtools::install_github("vitkl/MItools", dependencies = T)
}
suppressPackageStartupMessages({
    library(MItools)
})

colors = RColorBrewer::brewer.pal(2, "Dark2")

N_negative_sets = 200
motif_types = c("MOD", "LIG", "DOC") # "MOD", "LIG", "DOC" / "DEG", "CLV", "TRG"
neg_set = c("all_instances") # "all_instances", "all_proteins", "random"
query_predictor_col = "Sig" # "Sig" or "p.value" or "domain_motif_pval"
filter_by_domain_data = "p.value < 0.5" # "p.value < 0.05" or "fdr_pval < 0.05 & domain_count_per_IDs_interactor_viral > 1" or NULL
#ROC:
measure1 = "tpr" # "tpr" or "prec"
measure2 = "fpr" # "fpr" or "rec"

datasets = c("qslimfinder.Full_IntAct.FALSE",
             "qslimfinder.Vidal.FALSE", 
             "qslimfinder.BioPlex.FALSE")#, 
             #"qslimfinder.randomised_BioPlex.FALSE",
             #"qslimfinder.all_viral_interaction.FALSE")
descriptions = c("human network (full IntAct) searched \nfor motifs present in viral proteins",
                 "human network (Vidal's data only) searched \nfor motifs present in viral proteins",
                 "human network (BioPlex data only) searched \nfor motifs present in viral proteins")#,
                 #"human network (randomised BioPlex data) searched \nfor motifs present in viral proteins",
                 #"human network (human-viral data only) searched \nfor motifs present in viral proteins")
motif_setup_month = c("201712",
                      "201712",
                      "201801")#,
                      #,
                      #"201712")
```

## human network searched for motifs present in viral proteins

All interaction of viral proteins present in IntAct are used for analysis. All viral proteins are used as a query (QSLIMFinder identifies motifs only if they are present in a query sequence).

### without domain information (predictor - SLIMFinder "Sig")

```{r, viral}
res_list_viral = mBenchmarkMotifs(datasets = datasets, 
            descriptions = descriptions,
            dir = "./", 
            merge_domain_data = F, neg_set = neg_set,
            domain_res_file = "./processed_data_files/what_we_find_VS_ELM_clust20171019.RData",
            domain_results_obj = "res_count", motif_input_obj = "forSLIMFinder_Ready",
            one_from_cloud = T, type = "QSLIMFinder",
            dbfile_main = "./data_files/instances9606.gff",
            dburl_main = "http://elm.eu.org/instances.gff?q=None&taxon=Homo%20sapiens&instance_logic=",
            dbfile_query = "./data_files/instances10239.gff",
            dburl_query = "http://elm.eu.org/instances.gff?q=all&taxon=irus&instance_logic=",
            query_res_query_only = T, motif_types = motif_types,
            all_res_excl_query = T,
            seed = 21, N = N_negative_sets, replace = T, within1sequence = T,
            query_predictor_col = "Sig", all_predictor_col = "Sig", normalise = T,
            minoverlap = 2, maxgap = 0, motif_setup_month = motif_setup_month,
            count_ranges_by = list(by = "IDs_domain_human", name = "motif_occ_per_domain",
                                   normalise_by = "domain_count", normalised_name = "normalised_motif_occ_per_domain"),
            filter_by_domain_data = filter_by_domain_data)

par(mar = c(6,7,4,4))
# mBenchmarkMotifsROC(res_list_viral, data_type = "query", col_query = colors[1], col_all = colors[2], lwd = 4, text_args = "col = \"black\" | cex = 2", legend_args = "x = 0.35 | y = 0.45 | cex = 1.7 | y.intersp = 1.2 | box.col = \"transparent\"| bg = \"transparent\"", cex.axis = 1.6, cex.lab = 1.7, cex.main = 2, xlim = c(0,1), ylim = c(0,1), measure1 = measure1, measure2 = measure2)
mBenchmarkMotifsROC(res_list_viral, data_type = "both", col_query = colors[1], col_all = colors[2], lwd = 4, text_args = "col = \"black\" | cex = 2", legend_args = "x = 0.35 | y = 0.45 | cex = 1.7 | y.intersp = 1.2 | box.col = \"transparent\"| bg = \"transparent\"", cex.axis = 1.6, cex.lab = 1.7, cex.main = 2, xlim = c(0,1), ylim = c(0,1), measure1 = measure1, measure2 = measure2)
```

What is the minimal set size that returns motif with Sig < 0.05?  
`r min(res_list_viral$Mann$occurence$SeqNum[res_list_viral$Mann$occurence$Sig_not_normalised < 0.1])`  

### with domain information (predictor - "domain_motif_pval" = motif_pval * domain_pval)

Looks like proteins with many domains tend to interact with known motifs.

```{r, viral_w_domains}
res_list_viral_w_domains = mBenchmarkMotifs(datasets = datasets, 
            descriptions = descriptions,
            dir = "./", 
            merge_domain_data = T, neg_set = neg_set,
            domain_res_file = "./processed_data_files/what_we_find_VS_ELM_clust20171019.RData",
            domain_results_obj = "res_count", motif_input_obj = "forSLIMFinder_Ready",
            one_from_cloud = T, type = "QSLIMFinder",
            dbfile_main = "./data_files/instances9606.gff",
            dburl_main = "http://elm.eu.org/instances.gff?q=None&taxon=Homo%20sapiens&instance_logic=",
            dbfile_query = "./data_files/instances10239.gff",
            dburl_query = "http://elm.eu.org/instances.gff?q=all&taxon=irus&instance_logic=",
            query_res_query_only = T, motif_types = motif_types,
            all_res_excl_query = T,
            seed = 21, N = N_negative_sets, replace = T, within1sequence = T,
            query_predictor_col = query_predictor_col, all_predictor_col = "Sig", normalise = T,
            minoverlap = 2, maxgap = 0, motif_setup_month = motif_setup_month,
            count_ranges_by = list(by = "IDs_domain_human", name = "motif_occ_per_domain",
                                   normalise_by = "domain_count", normalised_name = "normalised_motif_occ_per_domain"),
            filter_by_domain_data = filter_by_domain_data)

par(mar = c(6,7,4,4))
# mBenchmarkMotifsROC(res_list_viral_w_domains, data_type = "query", col_query = colors[1], col_all = colors[2], lwd = 4, text_args = "col = \"black\" | cex = 2", legend_args = "x = 0.35 | y = 0.45 | cex = 1.7 | y.intersp = 1.2 | box.col = \"transparent\"| bg = \"transparent\"", cex.axis = 1.6, cex.lab = 1.7, cex.main = 2, xlim = c(0,1), ylim = c(0,1), measure1 = measure1, measure2 = measure2)
mBenchmarkMotifsROC(res_list_viral_w_domains, data_type = "both", col_query = colors[1], col_all = colors[2], lwd = 4, text_args = "col = \"black\" | cex = 2", legend_args = "x = 0.35 | y = 0.45 | cex = 1.7 | y.intersp = 1.2 | box.col = \"transparent\"| bg = \"transparent\"", cex.axis = 1.6, cex.lab = 1.7, cex.main = 2, xlim = c(0,1), ylim = c(0,1), measure1 = measure1, measure2 = measure2)
#queryOCCByMCOL(res_list_viral_w_domains$full_Intact, keytype = "IDs_domain_human", key = "IPR032440")
```

```{r, exit}
Sys.Date. = Sys.Date()
Sys.Date.
session_info. = devtools::session_info()
session_info.
filter_by_domain_data_print = gsub(" ","",filter_by_domain_data)
filter_by_domain_data_print = gsub("<*","",filter_by_domain_data_print)
filter_by_domain_data_print = gsub("<*","",filter_by_domain_data_print)
filter_by_domain_data_print = gsub("=*","",filter_by_domain_data_print)
filename = paste0("./processed_data_files/compr_benchmarking_strateg",format(Sys.Date(), "%Y%m"),"_",paste0(motif_types,collapse = "_"),"_",neg_set,"_",query_predictor_col,"_", filter_by_domain_data_print,"_type_", measure1, measure2,".RData")
save(list = ls(), file=filename)
```